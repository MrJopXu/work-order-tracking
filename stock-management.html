// Stock Management System - Clean Version

// === CONFIGURATION ===
const CONFIG = {
  ICONS: {
    DASHBOARD: 'fa-tachometer-alt',
    PLUS: 'fa-plus',
    LIST: 'fa-list',
    BOXES: 'fa-boxes',
    USERS: 'fa-users',
    COG: 'fa-cog',
    CHART: 'fa-chart-bar',
    TASKS: 'fa-tasks',
    PRINT: 'fa-print',
    SHIPPING: 'fa-shipping-fast',
    PALETTE: 'fa-palette'
  },
  
  ACTIONS: {
    DASHBOARD: 'loadDashboard',
    CREATE_ORDER: 'showCreateOrder',
    STOCK_MANAGEMENT: 'showStockManagement',
    SHIPPING: 'showShipping',
    CUSTOMERS: 'showCustomers',
    MY_TASKS: 'showMyTasks',
    PRODUCTION_QUEUE: 'showProductionQueue',
    REPORTS: 'showReports',
    ALL_ORDERS: 'showAllOrders',
    USERS: 'showUsers',
    SETTINGS: 'showSettings',
    NEW_ORDER: 'showNewOrder',
    FILM_TASKS: 'showFilmTasks',
    LAYOUT_TASKS: 'showLayoutTasks'
  }
};

// === MENU STRUCTURE ===
const MENU_ITEMS = {
  dashboard: {
    text: 'Dashboard',
    icon: CONFIG.ICONS.DASHBOARD,
    action: CONFIG.ACTIONS.DASHBOARD
  },
  createOrder: {
    text: 'Create Order',
    icon: CONFIG.ICONS.PLUS,
    action: CONFIG.ACTIONS.CREATE_ORDER
  },
  stockManagement: {
    text: 'Stock Management',
    icon: CONFIG.ICONS.LIST,
    action: CONFIG.ACTIONS.STOCK_MANAGEMENT
  },
  shipping: {
    text: 'Shipping',
    icon: CONFIG.ICONS.SHIPPING,
    action: CONFIG.ACTIONS.SHIPPING
  },
  customers: {
    text: 'Customers',
    icon: CONFIG.ICONS.USERS,
    action: CONFIG.ACTIONS.CUSTOMERS
  },
  myTasks: {
    text: 'My Tasks',
    icon: CONFIG.ICONS.TASKS,
    action: CONFIG.ACTIONS.MY_TASKS
  },
  productionQueue: {
    text: 'Production Queue',
    icon: CONFIG.ICONS.TASKS,
    action: CONFIG.ACTIONS.PRODUCTION_QUEUE
  },
  reports: {
    text: 'Reports',
    icon: CONFIG.ICONS.CHART,
    action: CONFIG.ACTIONS.REPORTS
  },
  allOrders: {
    text: 'All Orders',
    icon: CONFIG.ICONS.BOXES,
    action: CONFIG.ACTIONS.ALL_ORDERS
  },
  users: {
    text: 'Users',
    icon: CONFIG.ICONS.USERS,
    action: CONFIG.ACTIONS.USERS
  },
  settings: {
    text: 'Settings',
    icon: CONFIG.ICONS.COG,
    action: CONFIG.ACTIONS.SETTINGS
  },
  newOrder: {
    text: 'New Order',
    icon: CONFIG.ICONS.PLUS,
    action: CONFIG.ACTIONS.NEW_ORDER
  },
  filmTasks: {
    text: 'Film Tasks',
    icon: CONFIG.ICONS.PRINT,
    action: CONFIG.ACTIONS.FILM_TASKS
  },
  layoutTasks: {
    text: 'Layout Tasks',
    icon: CONFIG.ICONS.PALETTE,
    action: CONFIG.ACTIONS.LAYOUT_TASKS
  }
};

// === ROLE-BASED ACCESS ===
const ROLE_MENUS = {
  admin: [
    'dashboard',
    'createOrder',
    'stockManagement',
    'shipping',
    'customers',
    'reports',
    'allOrders',
    'users',
    'settings'
  ],
  stockManager: [
    'dashboard',
    'stockManagement',
    'reports'
  ],
  production: [
    'dashboard',
    'myTasks',
    'productionQueue'
  ],
  designer: [
    'dashboard',
    'myTasks',
    'layoutTasks'
  ],
  basic: [
    'dashboard',
    'myTasks'
  ]
};

// === MENU BUILDER ===
class MenuSystem {
  constructor() {
    this.currentRole = null;
    this.menuItems = MENU_ITEMS;
    this.roleMenus = ROLE_MENUS;
  }

  // Initialize menu based on user role
  initializeMenu(role) {
    this.currentRole = role;
    const menuKeys = this.roleMenus[role];
    
    if (!menuKeys) {
      console.error(`Role "${role}" not found`);
      return null;
    }

    const menuHTML = this.buildMenuHTML(menuKeys);
    this.renderMenu(menuHTML);
    this.attachEventListeners();
    
    console.log(`Menu initialized for role: ${role}`);
  }

  // Build HTML for menu
  buildMenuHTML(menuKeys) {
    const items = menuKeys.map(key => {
      const item = this.menuItems[key];
      if (!item) return '';
      
      return `
        <li class="nav-item">
          <a class="nav-link" href="#" data-action="${item.action}">
            <i class="fa ${item.icon}"></i>
            <span>${item.text}</span>
          </a>
        </li>
      `;
    }).join('');

    return `<ul class="nav flex-column">${items}</ul>`;
  }

  // Render menu to DOM
  renderMenu(html) {
    const container = document.getElementById('sidebar-menu');
    if (container) {
      container.innerHTML = html;
    }
  }

  // Attach event listeners
  attachEventListeners() {
    document.querySelectorAll('[data-action]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const action = e.currentTarget.dataset.action;
        this.handleAction(action);
      });
    });
  }

  // Handle menu actions
  handleAction(action) {
    console.log(`Executing action: ${action}`);
    
    // Call the corresponding function if it exists
    if (typeof window[action] === 'function') {
      window[action]();
    } else {
      console.warn(`Action function "${action}" not found`);
      // Create placeholder
      this.createPlaceholderAction(action);
    }
  }

  // Create placeholder for missing actions
  createPlaceholderAction(action) {
    window[action] = () => {
      console.log(`Placeholder for: ${action}`);
      // You can add default behavior here
    };
  }
}

// === STOCK MANAGEMENT MODULE ===
class StockManagement {
  constructor() {
    this.inventory = [];
    this.loadInventory();
  }

  // Load inventory from storage
  loadInventory() {
    const saved = localStorage.getItem('inventory');
    if (saved) {
      this.inventory = JSON.parse(saved);
    }
  }

  // Save inventory to storage
  saveInventory() {
    localStorage.setItem('inventory', JSON.stringify(this.inventory));
  }

  // Add new item
  addItem(item) {
    const newItem = {
      id: Date.now(),
      ...item,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    this.inventory.push(newItem);
    this.saveInventory();
    return newItem;
  }

  // Update existing item
  updateItem(id, updates) {
    const index = this.inventory.findIndex(item => item.id === id);
    if (index !== -1) {
      this.inventory[index] = {
        ...this.inventory[index],
        ...updates,
        updatedAt: new Date().toISOString()
      };
      this.saveInventory();
      return this.inventory[index];
    }
    return null;
  }

  // Remove item
  removeItem(id) {
    const index = this.inventory.findIndex(item => item.id === id);
    if (index !== -1) {
      const removed = this.inventory.splice(index, 1);
      this.saveInventory();
      return removed[0];
    }
    return null;
  }

  // Get all items
  getAllItems() {
    return this.inventory;
  }

  // Search items
  searchItems(query) {
    const q = query.toLowerCase();
    return this.inventory.filter(item => {
      return (
        item.name?.toLowerCase().includes(q) ||
        item.sku?.toLowerCase().includes(q) ||
        item.category?.toLowerCase().includes(q)
      );
    });
  }

  // Get item by ID
  getItemById(id) {
    return this.inventory.find(item => item.id === id);
  }

  // Get low stock items
  getLowStockItems(threshold = 10) {
    return this.inventory.filter(item => item.quantity <= threshold);
  }
}

// === ACTION HANDLERS ===
function loadDashboard() {
  console.log('Loading dashboard...');
  // Implement dashboard loading
}

function showStockManagement() {
  console.log('Opening stock management...');
  const stockUI = new StockManagementUI();
  stockUI.render();
}

// === STOCK MANAGEMENT UI ===
class StockManagementUI {
  constructor() {
    this.stockManager = new StockManagement();
    this.container = document.getElementById('main-content');
  }

  render() {
    const items = this.stockManager.getAllItems();
    
    this.container.innerHTML = `
      <div class="stock-management">
        <div class="header">
          <h2>Stock Management</h2>
          <button class="btn btn-primary" onclick="stockUI.showAddItemForm()">
            <i class="fa fa-plus"></i> Add Item
          </button>
        </div>
        
        <div class="search-bar">
          <input type="text" class="form-control" placeholder="Search items..." 
                 onkeyup="stockUI.handleSearch(this.value)">
        </div>
        
        <div class="stock-table">
          <table class="table">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Name</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="stock-items">
              ${this.renderItems(items)}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  renderItems(items) {
    if (items.length === 0) {
      return '<tr><td colspan="5" class="text-center">No items found</td></tr>';
    }
    
    return items.map(item => `
      <tr>
        <td>${item.sku || 'N/A'}</td>
        <td>${item.name}</td>
        <td>${item.category || 'N/A'}</td>
        <td>${item.quantity}</td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="stockUI.editItem(${item.id})">
            <i class="fa fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-danger" onclick="stockUI.deleteItem(${item.id})">
            <i class="fa fa-trash"></i>
          </button>
        </td>
      </tr>
    `).join('');
  }

  handleSearch(query) {
    const items = query ? 
      this.stockManager.searchItems(query) : 
      this.stockManager.getAllItems();
    
    document.getElementById('stock-items').innerHTML = this.renderItems(items);
  }

  showAddItemForm() {
    // Implement add item form
    console.log('Show add item form');
  }

  editItem(id) {
    // Implement edit item
    console.log('Edit item:', id);
  }

  deleteItem(id) {
    if (confirm('Are you sure you want to delete this item?')) {
      this.stockManager.removeItem(id);
      this.render();
    }
  }
}

// === INITIALIZATION ===
let menuSystem;
let stockUI;

document.addEventListener('DOMContentLoaded', () => {
  // Initialize menu system
  menuSystem = new MenuSystem();
  
  // Get user role (in real app, this would come from authentication)
  const userRole = 'admin'; // Example role
  
  // Initialize menu for user role
  menuSystem.initializeMenu(userRole);
  
  // Initialize stock UI (global for onclick handlers)
  stockUI = new StockManagementUI();
  
  console.log('Stock Management System initialized');
});

// === EXPORT (if needed) ===
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    MenuSystem,
    StockManagement,
    StockManagementUI
  };
}

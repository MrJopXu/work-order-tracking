// ULTIMATE LOGIN FIX - FORCE OVERRIDE

// 1. Clear everything first
localStorage.clear();
sessionStorage.clear();
console.log('Cleared all storage');

// 2. Set correct users
const users = [
  { username: 'manager1', password: 'pass123', role: 'manager' },
  { username: 'admin1', password: 'pass123', role: 'admin' },
  { username: 'designer1', password: 'pass123', role: 'designer' },
  { username: 'prod1', password: 'pass123', role: 'production' }
];
localStorage.setItem('users', JSON.stringify(users));

// 3. Override ALL form submissions
document.addEventListener('submit', function(e) {
  e.preventDefault();
  e.stopPropagation();
  tryLogin();
  return false;
}, true);

// 4. Override ALL button clicks
document.addEventListener('click', function(e) {
  if (e.target.tagName === 'BUTTON' || 
      e.target.type === 'submit' ||
      e.target.classList.contains('btn')) {
    e.preventDefault();
    e.stopPropagation();
    tryLogin();
    return false;
  }
}, true);

// 5. Login function
function tryLogin() {
  // Find inputs dengan berbagai cara
  let username = '';
  let password = '';
  
  // Method 1
  const userInput = document.querySelector('#username');
  const passInput = document.querySelector('#password');
  
  if (userInput && passInput) {
    username = userInput.value;
    password = passInput.value;
  } else {
    // Method 2
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
      if (input.type === 'text' || input.name === 'username') username = input.value;
      if (input.type === 'password' || input.name === 'password') password = input.value;
    });
  }
  
  console.log('Login attempt:', username, password);
  
  // Check credentials
  const validUser = users.find(u => u.username === username && u.password === password);
  
  if (validUser) {
    console.log('Valid user found!');
    
    // Set session dengan berbagai cara
    sessionStorage.setItem('isLoggedIn', 'true');
    sessionStorage.setItem('loggedIn', 'true');
    sessionStorage.setItem('authenticated', 'true');
    
    localStorage.setItem('currentUser', JSON.stringify(validUser));
    localStorage.setItem('isLoggedIn', 'true');
    localStorage.setItem('user', JSON.stringify(validUser));
    
    alert('Login SUCCESS! Redirecting...');
    
    // Multiple redirect attempts
    setTimeout(() => {
      window.location.href = './dashboard.html';
      window.location.replace('./dashboard.html');
      window.location = 'dashboard.html';
      window.open('./dashboard.html', '_self');
    }, 100);
  } else {
    alert(`Wrong credentials!\n\nUse:\nUsername: admin1\nPassword: pass123`);
  }
}

// 6. Manual direct login
window.forceLogin = function() {
  console.log('Force login as admin...');
  
  const adminUser = {
    username: 'admin1',
    password: 'pass123',
    role: 'admin',
    name: 'Admin'
  };
  
  // Set everything
  sessionStorage.setItem('isLoggedIn', 'true');
  sessionStorage.setItem('loggedIn', 'true');
  localStorage.setItem('currentUser', JSON.stringify(adminUser));
  localStorage.setItem('isLoggedIn', 'true');
  
  // Force redirect
  window.location.href = './dashboard.html';
};

// 7. Fill form automatically
function autoFill() {
  const userInput = document.querySelector('#username, input[type="text"], input[name="username"]');
  const passInput = document.querySelector('#password, input[type="password"], input[name="password"]');
  
  if (userInput) userInput.value = 'admin1';
  if (passInput) passInput.value = 'pass123';
  
  console.log('Form auto-filled with admin1/pass123');
}

// 8. Show big hint
const bigHint = document.createElement('div');
bigHint.style.cssText = `
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: red;
  color: white;
  padding: 30px;
  font-size: 20px;
  z-index: 99999;
  border-radius: 10px;
  text-align: center;
`;
bigHint.innerHTML = `
  <h2>LOGIN CREDENTIALS</h2>
  <p>Username: <strong>admin1</strong></p>
  <p>Password: <strong>pass123</strong></p>
  <button onclick="forceLogin()" style="
    background: white;
    color: red;
    border: none;
    padding: 10px 20px;
    font-size: 18px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 20px;
  ">FORCE LOGIN AS ADMIN</button>
  <br>
  <button onclick="this.parentElement.remove()" style="
    background: transparent;
    color: white;
    border: 2px solid white;
    padding: 10px 20px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
  ">Close</button>
`;
document.body.appendChild(bigHint);

// 9. Run everything
autoFill();

console.log(`
====================================
SUPER FIX LOADED!
====================================
1. Form sudah di-fill otomatis
2. Klik FORCE LOGIN AS ADMIN di popup merah
3. Atau isi manual: admin1 / pass123

Commands:
- forceLogin() : Bypass login
- autoFill() : Fill form
====================================
`);
